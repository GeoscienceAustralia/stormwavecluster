
# **Creation of storm wave event summary statistics**
------------------------------------------------------

*Gareth Davies, Geoscience Australia 2017*

# Introduction
------------------

This document illustrates the extraction of storm wave event summary statistics
from observational wave and tide data, using R code. It was generated from the
file [preprocess_data.Rmd](preprocess_data.Rmd), using the literate programming R package *knitr*. 

If you have R installed, along with all the packages required to run this code,
and a copy of the *stormwavecluster* git repository, then you should be able to
re-run the analysis here by simply copy-pasting the code (or using *knitr* to
extract it to a script).

The basic approach followed here is to:
* **Step 1:** Parse relevant wave time-series data at a number of sites (all near-ish to Old Bar), and convert them to a single time-series representing waves at Old Bar. 
* **Step 2:** Parse tidal observations, and astronomical tidal predictions, for a site near Old Bar.
* **Step 3:** Extract storm-events from these time-series, based on some precise definition of storms.
* **Step 4:** Extract *summary-statistics* describing each storm event.

The above summary statistics will later be subject to statistical modelling.


# **Step 1: Parse the wave time-series data**
--------------------------------------------

# *Parsing the measured wave time-series at Crowdy Head, Coffs Harbour and Sydney*
------------------------------------------------------------------------------------------

Here we parse measured wave time-series from Crowdy Head (since that is near
Old Bar, our primary site of interest). We also parse similar data measured at
Coffs Harbour and Sydney, for the purposes of filling gaps in the Crowdy Head
observations. 

First we read a script 'data_utilities.R' which contains functions for things
like 'reading the MHL wave data' into an environment. By using an environment,
we avoid the possibility of accidentally over-writing variables inside
'data_utilities.R'. You will have to read the 'data_utilities.R' code and comments
to understand each function. 

```{r readDU}
DU = new.env()
source('data_utilities.R', local=DU) 
```

Wave data for Crowdy Head, Coffs Harbour and Sydney was kindly provided by
Manly Hydraulics Laboratory, and is included in this repository. First we get
data measured from 1985-2014.

```{r get_1985_mhl_filenames}
mhl_wave_dir = '../../Data/NSW_Waves/'

# There are zipped csv files for each site, for the data from 1985-2014
mhl_wave_files = Sys.glob(paste0(mhl_wave_dir, '*1985*.csv.zip'))
mhl_wave_files

# Make a short name for each site
mhl_wave_sites = substr(basename(mhl_wave_files), 1, 4)
mhl_wave_sites

# Read the data
# wd = "wave data"
wd = DU$parse_MHL_wave_buoy_data(mhl_wave_sites, mhl_wave_files)

```

Next, we append data from 2015 to the above 1985-2014 data. We also read data
from another Sydney station which includes hindcast wave directions (based on
meteorological charts).

```{r append_recent_mhl_data}
# Update: In early 2016 we received updated wave-buoy data
#
# Append the updated MHL wave buoy data
mhl_wave_files = Sys.glob(paste0(mhl_wave_dir, '*2016*.csv.zip'))
mhl_wave_sites = substr(basename(mhl_wave_files), 1, 4)
wd_update = DU$parse_MHL_wave_buoy_data(mhl_wave_sites, mhl_wave_files)

for(nm in names(wd)){
    matchInds = match(wd_update[[nm]]$time, wd[[nm]]$time)

    ## Lots of checks here

    # From graphical checks the overlapping data seems identical
    # So matchInds should be a sequence of consecutive integers, followed
    # by a sequence of NA's
    stopifnot( (max(which(!is.na(matchInds))) + 1) == min(which(is.na(matchInds))) )
    stopifnot( max(diff(matchInds), na.rm=TRUE)  == 1)
    stopifnot( min(diff(matchInds), na.rm=TRUE)  == 1)

    # Ensure names and overlapping data are identical
    stopifnot(all(names(wd_update[[nm]]) == names(wd[[nm]])))
    for(varname in names(wd_update[[nm]])){
        stopifnot(
            all(range(wd_update[[nm]][[varname]] - wd[[nm]][[varname]][matchInds], 
                    na.rm=TRUE) == 
                c(0, 0))
            )
    }

    # If all those tests have passed, we can update the data with an rbind 
    ll = matchInds[1] - 1
    wd[[nm]] = rbind(wd[[nm]][1:ll,], wd_update[[nm]])
}


# Get the other sydney data. It's in a different format, so we parse it here,
# and append it to the 'wd' list

syd1 = read.table(
    unz(description = paste0(mhl_wave_dir, 'SYDNOW 17-7-1987 to 4-10-2000.csv.zip'), 
        filename = 'SYDNOW 17-7-1987 to 4-10-2000.csv'),
    skip=7, header=TRUE, sep=",")

# Add a time variable
syd1$time = strptime(syd1$Date.Time, format='%d-%B-%Y %H:%M', tz='Etc/GMT-10')
# Add names to data.frame
names(syd1) = c('datetime', 'hsig', 'hmax', 'tz', 'tsig', 'tp1', 'dir', 'time')
# Add a year variable
syd1$year = DU$time_to_year(syd1$time)
# Append to 'wd' list under the name 'SYDL'
wd$SYDL = syd1
```

As a result of the above operations, we have a list `wd` containing data.frames
for each station. The station names and data dimensions are:
```{r stationnames}
# Station names
names(wd)
# Number of rows/columns for each station
lapply(wd, dim)
```
The data format looks like this (using the example of Crowdy Head):
```{r stationformat}
wd$CRHD[1:10,]
```
The data for the SYDL station actually has a few more columns. That does not
affect the analysis so long as it also contains columns with the same names and
data as observed at the other stations.
```{r stationformat_2}
wd$SYDL[1:10,]
```

The data_utilities.R script includes a function to plot the station data.
Here's an example. Note there are gaps in the data, which will be filled at
a later stage of the analysis.
```{r plot2013}
# Plot 2013 for Crowdy head
DU$wave_data_single_year_plot(year=2013, site='CRHD', wd=wd, max_hsig=8, max_tp1=15)
```

# *Converting the wave observations to a single 'Old Bar' time-series*
----------------------------------------------------------------------

Here we create a 'gap-filled' wave time-series which we will treat as
representative of wave conditions at Old Bar. 

Because Crowdy Head is much closer to Old Bar than the other wave measuring
sites, it is natural to take measurements at Crowdy Head as a 'first
preference' representation of waves at Old Bar. When Crowdy Head data was
missing, we decided to gap-fill preferentially with data from Coffs Harbour. If
the latter were missing, we used Sydney observations, firstly from the `SYDD` site
(the directional wave-rider buoy, measured since 1992), and secondly from the
`SYDL` site (the long-reef wave-rider measurements complemented with hind-cast
wave-directional data). 

These preferences were justified by comparison of observed wave height and
direction at the gap-filling stations with those from Crowdy Head during
high-wave events. A few plots comparing wave heights and directions are shown
below. 

**Wave directions during storms @ Crowdy Head, in 2013**
```{r direction_compare, fig.width=10, fig.height=5}
# Compare wave directions in a year, when waves at Crowdy Head exceed hsig_thresh
hsig_thresh = 2.9
year2compare = 2013

par(mfrow=c(1,2))
DU$check_station_correlations(year2compare, 'CRHD', 'SYDD', wd, 'dir', 
    site1_restriction = (wd$CRHD$hsig > hsig_thresh))
title(main='Wave direction at Crowdy Head vs Sydney', line=0.5)
DU$check_station_correlations(year2compare, 'CRHD', 'COFH', wd, 'dir', 
    site1_restriction = (wd$CRHD$hsig > hsig_thresh))
title(main='Wave direction at Crowdy Head vs Coffs Harbour', line=0.5)
# Note -- we do not have SYDL direction data from this year
```

**Significant wave height during storms @ Crowdy Head, in 2013**
```{r hsig_compare, fig.width=10, fig.height=10}
# Compare 2013
par(mfrow=c(2,2))
DU$check_station_correlations(year2compare, 'CRHD', 'SYDD', wd, 'hsig',
    site1_restriction = (wd$CRHD$hsig > hsig_thresh))
title(main=bquote(H[sig] ~ 'at Crowdy Head vs Sydney'), line=0.5)
DU$check_station_correlations(year2compare, 'CRHD', 'COFH', wd, 'hsig',
    site1_restriction = (wd$CRHD$hsig > hsig_thresh))
title(main=bquote(H[sig] ~ 'at Crowdy Head vs Coffs Harbour'), line=0.5)
DU$check_station_correlations(1990, 'CRHD', 'SYDL', wd, 'hsig',
    site1_restriction = (wd$CRHD$hsig > hsig_thresh))
title(main=bquote(H[sig] ~ 'at Crowdy Head vs Long Reef'), line=0.5)
```
